<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900 text-white">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Imaeg Classifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-full flex flex-col items-center justify-start p-6 bg-gray-900 overflow-y-auto">

    <div class="w-full max-w-4xl space-y-6">
        
        <div class="text-center space-y-2">
            <h1 class="text-3xl font-bold text-white">classifier</h1>
            <p class="text-gray-400">1. Add objects &rarr; 2. Add Examples &rarr; 3. Predict them</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div class="bg-gray-800 shadow-2xl rounded-2xl p-6 flex flex-col space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold">Webcam or upload image?</h2>
                    <div class="bg-gray-700 p-1 rounded-lg flex text-sm">
                        <button id="modeWebcam" class="px-3 py-1 rounded bg-blue-600 text-white transition">Webcam</button>
                        <button id="modeUpload" class="px-3 py-1 rounded hover:bg-gray-600 text-gray-300 transition">Upload</button>
                    </div>
                </div>

                <div class="relative w-full aspect-video bg-black rounded-lg overflow-hidden border-2 border-gray-700">
                    <video id="webcamVideo" autoplay playsinline class="w-full h-full object-cover transform -scale-x-100"></video>
                    <img id="uploadPreview" class="w-full h-full object-contain hidden" src="" />
                    
                    <canvas id="captureCanvas" class="hidden"></canvas>
                </div>

                <div id="uploadControls" class="hidden">
                    <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-gray-700 file:text-white hover:file:bg-gray-600 cursor-pointer">
                </div>
            </div>

            <div class="bg-gray-800 shadow-2xl rounded-2xl p-6 flex flex-col">
                
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-semibold">Classes</h2>
                        <button onclick="resetModel()" class="text-xs text-red-400 hover:text-red-300 underline">Reset</button>
                    </div>
                    
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="newClassName" placeholder="New Class (e.g. 'Apple')" class="flex-1 bg-gray-700 border-none rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 outline-none">
                        <button onclick="addClass()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition">+ Add</button>
                    </div>

                    <div id="classList" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                        <p class="text-gray-500 text-sm italic text-center py-4" id="emptyClassMsg">Add a object to start training!!</p>
                    </div>
                </div>

                <hr class="border-gray-700 mb-6">

                <div class="mt-auto">
                    <button id="guessButton" class="w-full bg-green-600 disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-bold py-4 px-4 rounded-xl hover:bg-green-500 transition duration-300 flex items-center justify-center shadow-lg" disabled>
                        <span id="buttonText">Predict</span>
                        <div id="loadingSpinner" class="spinner hidden ml-3"></div>
                    </button>

                    <div id="resultBox" class="mt-4 p-4 bg-gray-900 rounded-xl border border-gray-700 hidden">
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-gray-400 text-sm uppercase tracking-wider">Prediction</p>
                                <h3 id="predictionLabel" class="text-2xl font-bold text-white mt-1">--</h3>
                            </div>
                            <div class="text-right">
                                <p class="text-gray-400 text-sm">Confidence</p>
                                <p id="predictionScore" class="text-xl font-mono text-green-400">--%</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const GROQ_API_KEY = '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'; 
        
        let classes = []; 
        let currentMode = 'webcam'; 
        let currentInputBase64 = null; 
        let stream = null;

        const webcamVideo = document.getElementById('webcamVideo');
        const uploadPreview = document.getElementById('uploadPreview');
        const imageUpload = document.getElementById('imageUpload');
        const captureCanvas = document.getElementById('captureCanvas');
        const classList = document.getElementById('classList');
        const newClassName = document.getElementById('newClassName');
        const guessButton = document.getElementById('guessButton');
        const resultBox = document.getElementById('resultBox');
        const predictionLabel = document.getElementById('predictionLabel');
        const predictionScore = document.getElementById('predictionScore');
        const spinner = document.getElementById('loadingSpinner');
        const btnText = document.getElementById('buttonText');

        async function initWebcam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                webcamVideo.srcObject = stream;
            } catch (err) {
                console.error("Webcam error:", err);
                alert("Could not access webcam. Switching to upload mode.");
                switchMode('upload');
            }
        }

        function stopWebcam() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        function switchMode(mode) {
            currentMode = mode;
            const modeWebcamBtn = document.getElementById('modeWebcam');
            const modeUploadBtn = document.getElementById('modeUpload');
            const uploadControls = document.getElementById('uploadControls');

            if (mode === 'webcam') {
                modeWebcamBtn.className = "px-3 py-1 rounded bg-blue-600 text-white transition";
                modeUploadBtn.className = "px-3 py-1 rounded hover:bg-gray-600 text-gray-300 transition";
                webcamVideo.classList.remove('hidden');
                uploadPreview.classList.add('hidden');
                uploadControls.classList.add('hidden');
                initWebcam();
            } else {
                modeWebcamBtn.className = "px-3 py-1 rounded hover:bg-gray-600 text-gray-300 transition";
                modeUploadBtn.className = "px-3 py-1 rounded bg-blue-600 text-white transition";
                webcamVideo.classList.add('hidden');
                uploadPreview.classList.remove('hidden');
                uploadControls.classList.remove('hidden');
                stopWebcam();
            }
            checkPredictability();
        }

        document.getElementById('modeWebcam').addEventListener('click', () => switchMode('webcam'));
        document.getElementById('modeUpload').addEventListener('click', () => switchMode('upload'));

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    uploadPreview.src = ev.target.result;
                    currentInputBase64 = ev.target.result;
                    checkPredictability();
                };
                reader.readAsDataURL(file);
            }
        });

        guessButton.addEventListener('click', predict);

        function getCurrentImage() {
            if (currentMode === 'upload') {
                return currentInputBase64;
            } else {
                const context = captureCanvas.getContext('2d');
                captureCanvas.width = webcamVideo.videoWidth;
                captureCanvas.height = webcamVideo.videoHeight;
                context.drawImage(webcamVideo, 0, 0, captureCanvas.width, captureCanvas.height);
                return captureCanvas.toDataURL('image/jpeg', 0.5);
            }
        }

        function addClass() {
            const name = newClassName.value.trim();
            if (!name) return;
            if (classes.find(c => c.name === name)) {
                alert("Class already exists!");
                return;
            }

            classes.push({ name: name, samples: [] });
            newClassName.value = '';
            renderClasses();
            checkPredictability();
        }

        function trainClass(index) {
            const imgData = getCurrentImage();
            if (!imgData) {
                alert("No image source found. Check webcam or upload an image.");
                return;
            }
            if(classes[index].samples.length >= 3) {
               classes[index].samples.shift(); 
            }
            classes[index].samples.push(imgData);
            renderClasses();
            checkPredictability();
            
            const btn = document.getElementById(`train-btn-${index}`);
            if(btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = "Saved!";
                btn.classList.add('bg-green-600');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-green-600');
                }, 500);
            }
        }

        function resetModel() {
            if(confirm("Are you sure you want to delete all training data?")) {
                classes = [];
                renderClasses();
                resultBox.classList.add('hidden');
                checkPredictability();
            }
        }

        function renderClasses() {
            const container = document.getElementById('classList');
            container.innerHTML = ''; 

            if (classes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm italic text-center py-4">Add a class to start training</p>';
                return;
            }

            classes.forEach((cls, idx) => {
                const div = document.createElement('div');
                div.className = "bg-gray-700 p-3 rounded-lg flex items-center justify-between";
                
                let thumbnails = cls.samples.map(s => 
                    `<img src="${s}" class="w-8 h-8 rounded border border-gray-500 object-cover">`
                ).join('');

                div.innerHTML = `
                    <div class="flex flex-col overflow-hidden">
                        <span class="font-bold truncate">${cls.name}</span>
                        <div class="flex gap-1 mt-1 h-8">${thumbnails || '<span class="text-xs text-gray-400 py-1">No samples</span>'}</div>
                    </div>
                    <button id="train-btn-${idx}" onclick="trainClass(${idx})" class="ml-2 bg-gray-600 hover:bg-gray-500 text-white text-sm px-3 py-2 rounded shadow transition whitespace-nowrap">
                        ðŸ“· Train
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function checkPredictability() {
            const hasSource = currentMode === 'webcam' || currentInputBase64;
            guessButton.disabled = !hasSource;
        }

        async function predict() {
            const targetImage = getCurrentImage();
            if (!targetImage) return;

            setLoading(true);
            resultBox.classList.add('hidden');
            
            let systemPrompt = "You are a vision AI. Identify the image.";
            let messages = [];

            if (classes.length > 0 && classes.some(c => c.samples.length > 0)) {
                const classNames = classes.map(c => c.name).join(", ");
                systemPrompt = `You are a strict image classifier. You have been trained to recognize these specific classes: [${classNames}]. 
                
                I will provide labeled examples (training data) first. 
                Based ONLY on these examples, classify the final image. 
                
                IMPORTANT: You must return valid JSON only. No markdown. No introductory text.
                Format: { "guess": "Name of the class", "accuracy": "Percentage string (e.g. 95%)" }`;

                messages.push({ role: "system", content: systemPrompt });

                classes.forEach(cls => {
                    cls.samples.forEach(sampleBase64 => {
                        messages.push({
                            role: "user",
                            content: [
                                { type: "text", text: `Training Example: This image is a ${cls.name}` },
                                { type: "image_url", image_url: { url: sampleBase64 } }
                            ]
                        });
                    });
                });

                messages.push({
                    role: "user",
                    content: [
                        { type: "text", text: "Now, based on the examples above, what class is this image? Return strictly JSON." },
                        { type: "image_url", image_url: { url: targetImage } }
                    ]
                });

            } else {
                systemPrompt = `Identify the main subject of the image. Return strictly valid JSON only. Format: { "guess": "string", "accuracy": "string" }.`;
                messages.push({ role: "system", content: systemPrompt });
                messages.push({
                    role: "user",
                    content: [
                        { type: "text", text: "What is this?" },
                        { type: "image_url", image_url: { url: targetImage } }
                    ]
                });
            }

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'meta-llama/llama-4-scout-17b-16e-instruct', 
                        messages: messages,
                        temperature: 0.1,
                        max_tokens: 300
                    })
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`API Failed: ${response.status} ${errText}`);
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                const cleanJson = content.replace(/```json|```/g, '').trim();
                const result = JSON.parse(cleanJson);

                predictionLabel.textContent = result.guess;
                predictionScore.textContent = result.accuracy;
                resultBox.classList.remove('hidden');

            } catch (error) {
                console.error("Full error:", error);
                alert(`Error: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
            guessButton.disabled = isLoading;
            if(isLoading) {
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');
            } else {
                btnText.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }

        switchMode('webcam');
    </script>
</body>
</html>

